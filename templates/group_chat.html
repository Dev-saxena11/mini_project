<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group_name }} - Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header class="navbar">
    <div class="logo">Travel Together</div>
    <nav class="nav-links" id="nav-links">
        <a href="/home">Home</a>
        <a href="/user">Dashboard</a>
        <a href="/groups">‚Üê Back to Groups</a>
        {% if username %}
            <span style="margin-left: 15px;">üëã Hello, {{ username }}</span>
            <a href="/logout">Logout</a>
        {% endif %}
    </nav>
    <div class="menu-toggle" id="menu-toggle">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </div>
</header>

<main>
    <div class="group-chat-container">
        <h2>{{ group_name }}</h2>
        <div class="group-chat-messages" id="messages">
            </div>
        <form class="group-chat-form" id="chat-form">
            <input type="text" name="message" placeholder="Type a message..." required autocomplete="off">
            <button type="submit" class="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </form>
    </div>
</main>

<script>
    const messagesDiv = document.getElementById('messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = chatForm.querySelector('input[name="message"]');
    const loggedInUsername = "{{ username }}";

    // --- RENDER INITIAL MESSAGES ON PAGE LOAD ---
    const initialMessages = {{ messages | tojson }};
    window.addEventListener('load', () => {
        // Add a small delay to allow the page to render first
        setTimeout(() => {
            initialMessages.forEach(msg => addMessageToUI(msg, false)); // Don't animate initial load
            scrollToBottom(true); // Scroll instantly on load
        }, 100);
    });

    // --- HANDLE SENDING NEW MESSAGES ---
    chatForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const messageText = messageInput.value.trim();
        if (messageText === "") return;

        // Optimistically add the user's message to the UI
        const optimisticMessage = {
            sender_name: loggedInUsername,
            message: messageText,
            timestamp: new Date().toISOString()
        };
        addMessageToUI(optimisticMessage, true);
        const pendingMessageElement = messagesDiv.lastElementChild; // Get the element we just added
        pendingMessageElement.style.opacity = '0.6'; // Mark as 'sending'
        messageInput.value = '';

        try {
            const response = await fetch(`/api/messages/send/{{ group_id }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageText }),
            });
            const result = await response.json();

            if (result.status === 'success') {
                // Message sent successfully, update the UI to confirm
                pendingMessageElement.style.opacity = '1'; 
            } else {
                // If sending failed, indicate an error
                console.error("Error sending message:", result.message);
                pendingMessageElement.style.border = '1px solid red'; // Visual error indicator
            }
        } catch (error) {
            console.error("Network error:", error);
            pendingMessageElement.style.border = '1px solid red';
        }
    });

    /**
     * Creates and adds a message bubble to the UI.
     * @param {object} msg - The message object.
     * @param {boolean} animate - Whether to apply the entrance animation.
     */
    function addMessageToUI(msg, animate = true) {
        const messageContainer = document.createElement('div');
        const isOwnMessage = msg.sender_name === loggedInUsername;
        const messageClass = isOwnMessage ? 'own-message' : 'other-message';
        messageContainer.className = `message-container ${messageClass}`;
        
        // Use a placeholder for avatars. You could later replace this with real user avatars.
        const avatarLetter = msg.sender_name.charAt(0).toUpperCase();
        const avatarColor = isOwnMessage ? '0096c7' : 'ade8f4';
        const avatarTextColor = isOwnMessage ? 'ffffff' : '333333';

        const avatarHTML = `
            <img src="https://placehold.co/40x40/${avatarColor}/${avatarTextColor}?text=${avatarLetter}" alt="Avatar" class="chat-avatar">
        `;
        
        // Don't show the sender's name on their own messages
        const senderNameHTML = !isOwnMessage ? `<strong>${escapeHTML(msg.sender_name)}</strong>` : '';

        messageContainer.innerHTML = `
            ${avatarHTML}
            <div class="group-chat-message">
                ${senderNameHTML}
                <p>${escapeHTML(msg.message)}</p>
                <small>${formatSimpleTime(msg.timestamp)}</small>
            </div>
        `;
        
        // Remove animation class if we don't want to animate
        if (!animate) {
            const messageBubble = messageContainer.querySelector('.group-chat-message');
            messageBubble.style.animation = 'none';
        }

        messagesDiv.appendChild(messageContainer);
        scrollToBottom();
    }
    
    // --- UTILITY FUNCTIONS ---
    
    function formatSimpleTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: 'numeric',
            hour12: true
        });
    }

    function escapeHTML(str) {
        const p = document.createElement("p");
        p.appendChild(document.createTextNode(str));
        return p.innerHTML;
    }

    function scrollToBottom(instant = false) {
        messagesDiv.scrollTo({
            top: messagesDiv.scrollHeight,
            behavior: instant ? 'instant' : 'smooth'
        });
    }
</script>
</body>
</html>