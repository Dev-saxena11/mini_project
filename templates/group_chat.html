<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ group_name }} - Chat</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header class="navbar">
    <div class="logo">Travel Together</div>
    <nav class="nav-links" id="nav-links">
        <a href="/home">Home</a>
        <a href="/user">Dashboard</a>
        <a href="/groups">‚Üê Back to Groups</a>
        {% if username %}
            <span style="margin-left: 15px;">üëã Hello, {{ username }}</span>
            <a href="/logout">Logout</a>
        {% endif %}
    </nav>
    <div class="menu-toggle" id="menu-toggle">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </div>
</header>

<main>
    <div class="group-chat-container">
        <h2>{{ group_name }}</h2>
        <div class="group-chat-messages" id="messages">
            </div>
        <form class="group-chat-form" id="chat-form">
            <input type="text" name="message" placeholder="Type a message..." required autocomplete="off">
            <button type="submit" class="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </form>
    </div>
</main>

<script>
    const messagesDiv = document.getElementById('messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = chatForm.querySelector('input[name="message"]');
    const loggedInUsername = "{{ username }}";
    
    // RENDER INITIAL MESSAGES
    const initialMessages = {{ messages | tojson }};
    window.addEventListener('load', () => {
        initialMessages.forEach(msg => addMessageToUI(msg));
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // HANDLE SENDING NEW MESSAGES
    chatForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const messageText = messageInput.value.trim();
        if (messageText === "") return;

        try {
            const response = await fetch(`/api/messages/send/{{ group_id }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageText }),
            });
            const result = await response.json();

            if (result.status === 'success') {
                addMessageToUI(result.message);
                messageInput.value = '';
            } else {
                console.error("Error sending message:", result.message);
            }
        } catch (error) {
            console.error("Network error:", error);
        }
    });

    /**
     * Creates and adds a message bubble to the UI.
     * @param {object} msg - The message object.
     */
    function addMessageToUI(msg) {
        const messageContainer = document.createElement('div');
        const messageClass = msg.sender_name === loggedInUsername ? 'own-message' : 'other-message';
        messageContainer.className = `message-container ${messageClass}`;
    
        const avatarHTML = messageClass === 'other-message' 
            ? `<img src="https://placehold.co/40x40/ade8f4/333333?text=${msg.sender_name.charAt(0).toUpperCase()}" alt="Avatar" class="chat-avatar">`
            : '';

        messageContainer.innerHTML = `
            ${avatarHTML}
            <div class="group-chat-message">
                ${messageClass === 'other-message' ? `<strong>${msg.sender_name}</strong>` : ''}
                <p>${escapeHTML(msg.message)}</p>
                <small>${formatSimpleTime(msg.timestamp)}</small>
            </div>
        `;
    
        messagesDiv.appendChild(messageContainer);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function formatSimpleTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: 'numeric',
            hour12: true
        });
    }

    function escapeHTML(str) {
        const p = document.createElement("p");
        p.appendChild(document.createTextNode(str));
        return p.innerHTML;
    }
</script>
</body>
</html>